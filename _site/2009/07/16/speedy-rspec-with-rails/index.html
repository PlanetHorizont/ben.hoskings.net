<!DOCTYPE html>
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <meta content="width = 660" name="viewport" />
    <title>ben hoskings</title>
    <link href="/stylesheets/styles.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/index.atom" rel="alternate" title="Atom feed" type="application/atom+xml" />
    <script type="text/javascript">
      //<![CDATA[
        /**
          head.js    The only script in your <HEAD>
          Copyright  Tero Piirainen (tipiirai)
          License    MIT / http://bit.ly/mit-license
        
          http://headjs.com
        */(function(a){var b=a.documentElement,c={screens:[320,480,640,768,1024,1280,1440,1680,1920],section:"-section",page:"-page",head:"head"},d=[];if(window.head_conf)for(var e in head_conf)head_conf[e]&&(c[e]=head_conf[e]);function f(a){d.push(a)}function g(a){var c=new RegExp("\\b"+a+"\\b");b.className=b.className.replace(c,"")}function h(a,b){for(var c=0;c<a.length;c++)b.call(a,a[c],c)}var i=window[c.head]=function(){i.ready.apply(null,arguments)};i.feature=function(a,c,e){if(!a){b.className+=" "+d.join(" ");return d=[]}Object.prototype.toString.call(c)=="[object Function]"&&(c=c.call()),f((c?"":"no-")+a),i[a]=!!c,e||(g("no-"+a),g(a),i.feature());return i};var j=navigator.userAgent.toLowerCase();j=/(webkit)[ \/]([\w.]+)/.exec(j)||/(opera)(?:.*version)?[ \/]([\w.]+)/.exec(j)||/(msie) ([\w.]+)/.exec(j)||!/compatible/.test(j)&&/(mozilla)(?:.*? rv:([\w.]+))?/.exec(j)||[],j[1]=="msie"&&(j[1]="ie"),f(j[1]),i.browser={version:j[2]},i.browser[j[1]]=true;if(i.browser.ie)for(var k=3;k<11;k++)parseFloat(j[2])<k&&f("lt-ie"+k);h("abbr|article|aside|audio|canvas|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video".split("|"),function(b){a.createElement(b)}),h(location.pathname.split("/"),function(a,d){if(this.length>2&&this[d+1])d&&f(this.slice(1,d+1).join("-")+c.section);else{var e=a||"index",g=e.indexOf(".");g>0&&(e=e.substring(0,g)),b.id=e+c.page,d||f("root"+c.section)}});function l(){var a=window.outerWidth||b.clientWidth;b.className=b.className.replace(/ (w|lt)-\d+/g,""),f("w-"+Math.round(a/100)*100),h(c.screens,function(b){a<=b&&f("lt-"+b)}),i.feature()}l(),window.onresize=l,i.feature("script",true).feature()})(document),function(){var a=document.createElement("i"),b=a.style,c=" -o- -moz- -ms- -webkit- -khtml- ".split(" "),d=window.head_conf&&head_conf.head||"head",e=window[d];function f(a){b.cssText=c.join(a+";");var d=b.cssText;if(d.indexOf("-o")!=-1&&d.indexOf("-ms")!=-1)return false;return!!d}var g={gradient:function(){var a="background-image:",d="gradient(linear,left top,right bottom,from(#9f9),to(#fff));",e="linear-gradient(left top,#eee,#fff);";b.cssText=(a+c.join(d+a)+c.join(e+a)).slice(0,-a.length);return!!b.backgroundImage},rgba:function(){b.cssText="background-color:rgba(0,0,0,0.5)";return!!b.backgroundColor},boxshadow:function(){return f("box-shadow: 0 0 0 red")},textshadow:function(){return b.textShadow===""},multiplebgs:function(){b.cssText="background:url(//:),url(//:),red url(//:)";return(new RegExp("(url\\s*\\(.*?){3}")).test(b.background)},borderimage:function(){return f("border-image: url(m.png) 1 1 stretch")},borderradius:function(){return f("border-radius:0")},opacity:function(){return a.style.opacity===""},reflections:function(){return f("box-reflect:right 0")},transforms:function(){return f("transform:rotate(1deg)")},transitions:function(){return f("transition:all .1s linear")}};for(var h in g)g[h]&&e.feature(h,g[h].call(),true);e.feature()}(),function(a){var b=a.documentElement,c=navigator.userAgent.toLowerCase().indexOf("msie")!=-1,d=false,e=[],f={},g={};var h=window.head_conf&&head_conf.head||"head",i=window[h]=window[h]||function(){i.ready.apply(null,arguments)};i.js=function(){var a=arguments,b=[].slice.call(a,1),c=b[0];if(!d){e.push(function(){i.js.apply(null,a)});return i}c?(l(c)||k(b,function(a){l(a)||n(j(a))}),o(j(a[0]),l(c)?c:function(){i.js.apply(null,b)})):o(j(a[0]));return i},i.ready=function(a,b){var c=g[a];if(c&&c.state=="loaded"){b.call();return i}l(a)&&(b=a,a="ALL");var d=f[a];d?d.push(b):d=f[a]=[b];return i};function j(a){var b=g[a.name||a];if(b)return b;if(typeof a=="object")for(var c in a)a[c]&&(b={name:c,url:a[c]});else{var d=a.split("/"),e=d[d.length-1],f=e.indexOf("?");b={name:f!=-1?e.substring(0,f):e,url:a}}g[b.name]=b;return b}function k(a,b){if(a){typeof a=="object"&&(a=[].slice.call(a));for(var c=0;c<a.length;c++)b.call(a,a[c],c)}}function l(a){return Object.prototype.toString.call(a)=="[object Function]"}function m(a){a.state="preloaded",k(a.onpreload,function(a){a.call()})}function n(c,d){if(!c.state){c.state="preloading",c.onpreload=[];if(/Firefox/.test(navigator.userAgent)){var e=a.createElement("object");e.data=c.url,e.width=0,e.height=0,e.onload=function(){m(c),setTimeout(function(){b.removeChild(e)},1)},b.appendChild(e)}else p({src:c.url,type:"cache"},function(){m(c)})}}function o(a,b){if(a.state=="loaded")return b();if(a.state=="preloading")return a.onpreload.push(function(){o(a,b)});a.state="loading",p(a.url,function(){a.state="loaded",b&&b.call(),k(f[a.name],function(a){a.call()});var c=true;for(var d in g)g[d].state!="loaded"&&(c=false);c&&k(f.ALL,function(a){a.done||a.call(),a.done=true})})}function p(d,e){var f=a.createElement("script");f.type="text/"+(d.type||"javascript"),f.src=d.src||d,f.onreadystatechange=f.onload=function(){var a=f.readyState;!e.done&&(!a||/loaded|complete/.test(a))&&(e.call(),e.done=true),c||b.removeChild(f)},b.appendChild(f)}setTimeout(function(){d=true,k(e,function(a){a.call()})},200)}(document)
      //]]>
    </script>
    <!--[if IE]>
      <script type="text/javascript">
        //<![CDATA[
          // For discussion and comments, see: http://remysharp.com/2009/01/07/html5-enabling-script/
          (function(){if(!/*@cc_on!@*/0)return;var e = "abbr,article,aside,audio,bb,canvas,datagrid,datalist,details,dialog,eventsource,figure,footer,header,hgroup,mark,menu,meter,nav,output,progress,section,time,video".split(',');for(var i=0;i<e.length;i++){document.createElement(e[i])}})();
        //]]>
      </script>
    <![endif]-->
  </head>
  <body>
    <header>
      <h1>
        <a href="/">ben hoskings</a>
      </h1>
    </header>
    <nav>
      <a href="http://twitter.com/ben_h" rel="me">twitter</a>
      <a href="http://github.com/benhoskings" rel="me">github</a>
    </nav>
    <article>
      <header>
        <time pubdate="pubdate">2009 July 16</time>
        <h1>
          <a href="/">speedy rspec with rails</a>
        </h1>
      </header>
      <p>So rails rspec runs are really slow to start up. There are two reasons why:</p>
      
      <ul>
      <li>Rails is initialised each time, which takes a few seconds</li>
      
      <li><code>db:test:prepare</code> runs before each run, which is another complete rails initialisation in itself</li>
      </ul>
      
      <p>These delays don&#8217;t have anything to do with rspec. It&#8217;s just the nature of the Rails framework—there&#8217;s a lot of ruby to load, to get the framework off the ground. These tweaks don&#8217;t make that process any faster, they avoid it&#8212;firstly by removing a rails initialisation, and then by moving the delay of another away from each rspec run.</p>
      
      <p>To fix the first, install <a href='http://wiki.github.com/dchelimsky/rspec/spork-autospec-pure-bdd-joy'>spork</a> and configure it in <code>spec/spec_helper.rb</code>. Spork keeps an instance of your app running, and listens for connections from a spork-aware <code>rake spec</code> run. This removes the Rails startup delay more or less completely, since when you run <code>rake spec</code>, spork has your app ready and waiting to run specs transparently via DRb.</p>
      
      <p>As for the second, I don&#8217;t see any need to run <code>db:test:prepare</code> before every run when transactional fixtures are being used. It&#8217;s simple to disable. Change this</p>
      
      <pre><code>Spec::Rake::SpecTask.new(:spec =&gt; spec_prereq) do |t|</code></pre>
      
      <p>to this</p>
      
      <pre><code>Spec::Rake::SpecTask.new(:spec) do |t|</code></pre>
      
      <p>in <code>lib/tasks/rspec.rake</code>.</p>
      
      <p>With <code>db:test:prepare</code> and its subtasks not running, spork there&#8217;s less than a second of delay before specs start running. In my book, that&#8217;s close to fast enough to pleasantly run, and get results in realtime. Coupled with autotest, this should mean much snappier pass/fail feedback too.</p>
      
      <p>It seems messy to me to have those tasks defined within the app. In fact, most of the rails testing / speccing setup seems to involve just spraying messy generated code around the place. I think this is an example of something done wrong in spite of the fact that the tests may be passing.</p>
      
      <p>Next, to make ⌘R spec runs in TextMate spork-aware, head to the TextMate preferences and add <code>--drb</code> to the <code>TM_RSPEC_OPTS</code> variable (creating it if required). I also had to patch the <code>spec_mate</code> helper <a href='http://github.com/benhoskings/ruby-rspec.tmbundle/commit/c70b16106cd5ba74e97cc967d0e8f307850cbd28'>like so</a>.</p>
      
      <p>Running through spork causes a bit of a performance hit, too&#8212;it eliminates the startup delay, but the specs run slower, since there&#8217;s a DRb back and forth involved for each one. Spork is for running a few tests at a time, or for running through autotest, while you&#8217;re developing. When you run your full suite, you should stop the spork listener and run them locally at full speed.</p>
    </article>
    <footer>
      <span>
        Powered by
        <a href="http://github.com/mojombo/jekyll">Jekyll</a>
        Content &amp; layout &copy; Ben Hoskings.
      </span>
    </footer>
    <script type="text/javascript">
      //<![CDATA[
        head.js("/scripts/jquery.js");
        head.js("/scripts/images.js");
      //]]>
    </script>
    <script type="text/javascript">
      //<![CDATA[
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
        try {
          var pageTracker = _gat._getTracker("UA-9740324-2");
          pageTracker._trackPageview();
        } catch(err) {}
      //]]>
    </script>
  </body>
</html>
