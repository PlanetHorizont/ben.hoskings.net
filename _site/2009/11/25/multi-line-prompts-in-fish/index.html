<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <title>ben hoskings</title>
    <link href="/stylesheets/styles.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/index.atom" rel="alternate" title="Atom feed" type="application/atom+xml" />
  </head>
</html>
<body>
  <div id="page_container">
    <h1 id="page_heading">
      <a href="/">ben hoskings</a>
    </h1>
    <div id="navigation">
      <a href="http://twitter.com/ben_h" rel="me">twitter</a>
      <a href="http://github.com/benhoskings" rel="me">github</a>
    </div>
    <div id="main">
      <div class="post">
        <h2 class="title">multi-line prompts in fish</h2>
        <p>One thing I&#8217;ve missed since switching to fish is a multi-line prompt. If your prompt has newlines in it, they&#8217;re stripped out when the prompt is rendered on-screen.</p>
        
        <p>First things first: <a href='http://github.com/benhoskings/fish/commit/3e589050b1ab69e07982fb48e8a3bc80ccf1b09b'>here&#8217;s the patch</a>.</p>
        
        <pre><code>  for( i=0; i&lt;al_get_count( &amp;prompt_list); i++ )
          {
            sb_append( &amp;data-&gt;prompt_buff, (wchar_t *)al_get( &amp;prompt_list, i ) );
        +     if (i + 1 &lt; al_get_count( &amp;prompt_list))
        +     {
        +       sb_append( &amp;data-&gt;prompt_buff, L&quot;\n&quot; );
        +     }
          }
        
          al_foreach( &amp;prompt_list, &amp;free );</code></pre>
        
        <p>The reason the newlines are removed arises from the way fish runs subcommands. Rendering the prompt is a call to the <code>fish_prompt</code> function, which in turn runs other subcommands like <code>whoami</code>, <code>pwd</code> and <code>git ls-files</code>, depending what you have in your prompt.</p>
        
        <p>When fish receives <code>fish_prompt</code>&#8217;s output, it splits on <code>\n</code> and stores each line in an array, specifically an <code>array_list_t</code>. When the output is reassembled by <code>exec_prompt()</code> for output to the terminal, however, it joins the lines in the array (that&#8217;s <code>prompt_list</code> in the patch above) back together without any join token, so the line separation is gone.</p>
        
        <p>My patch adds a <code>\n</code> after every line but the last, so that the newlines in the original un-split output from <code>fish_prompt</code> are re-inserted for rendering.</p>
      </div>
    </div>
    <div id="footer">
      Powered by
      <a href="http://github.com/mojombo/jekyll">Jekyll</a>
      Content &amp; layout &copy; Ben Hoskings.
    </div>
  </div>
  <script type="text/javascript">
    //<![CDATA[
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
      try {
        var pageTracker = _gat._getTracker("UA-9740324-2");
        pageTracker._trackPageview();
      } catch(err) {}
    //]]>
  </script>
</body>
